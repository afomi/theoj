<polymer-element name="oj-new-annotation" attributes='location paper'>
<template>
  <div layout vertical center-center>
    <textarea value="{{text}}" placeholder="Type something..."> </textarea>

    <div layout horizontal end-justified class='controls'>
      <paper-icon-button on-click={{submit}}  icon="add"></paper-icon-button>
      <paper-icon-button on-click={{dismiss}} icon="close"></paper-icon-button>
    </div>
  </div>


  <core-ajax id="saveRequest"
            url="{{paper.sha | saveUrl}}"
            method="POST"
            contentType="application/json"
            handleAs=json
            on-core-response={{saved}}
            on-core-error={{error}}></core-ajax>

  <style>
    :host{
      z-index:1;
      height:200px;
      background-color:#607D8B;
      padding: 20px;
      min-height:100px;
      position:absolute;
      box-sizing:border-box;
      width:100%;
      left:0px;
    }
    textarea{
      resize: none;
      height: 100%;
      min-height:130px;
      border:none;
      width: 100%;
    }
    paper-autogrow-textarea{

    }
    .controls{
      width: 100%;
    }
    paper-icon-button{
      color:white;
    }
  </style>
</template>

<script>
  Polymer({
    submit: function(){
      this.$.saveRequest.body = this.annotationData()
      this.$.saveRequest.go()
    },
    dismiss:function(){
      this.fire("new-annotation-box-dismissed",{})
    },
    saved:function(response){
      this.fire("annotation-added", response.detail.response)
      this.fire("notification", "Annotation saved.")
      this.dismiss()
    },
    error:function(response){
      this.fire("notification", "Could not save annotation.")
    },
    annotationData:function(){
      var params = {
        annotation:{
          body: this.text,
          page: this.location.page,
          xStart: this.location.xStart,
          yStart: this.location.yStart
        }
      }

      return JSON.stringify(params)
    },
    saveUrl:function(paper_sha){
      return '/papers/'+paper_sha+'/annotations'
    }
  })
</script>
</polymer-element>
