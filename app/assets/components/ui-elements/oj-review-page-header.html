<polymer-element name="oj-review-page-header" attributes='user paper annotations loadProgress'>
  <template>
      <div class=top-header flex layout horizontal >
          <div  class=left flex>
              <div class=left-top>

                  <paper-dropdown-menu on-core-activate={{versionSelected}}>
                      <paper-dropdown class=dropdown>
                          <core-menu id=versionMenu valueattr=version selected={{paper.version}}>
                              <template repeat="{{version in paper.versions}}">
                                <paper-item version={{version.version}}>{{version.arxiv_id}} v{{version.version}}</paper-item>
                              </template>
                          </core-menu>
                      </paper-dropdown>
                  </paper-dropdown-menu>

                  <span class=title>{{paper.title}}</span>
                  <template repeat="{{assignment in paper.assigned_users | exceptReviewers}}" >
                      <oj-user-tag assignment={{assignment}}
                                   showColor={{!submitted}}
                                   tagColor={{userColor(assignment)}}
                              ></oj-user-tag>
                  </template>
              </div>

              <template if="{{paper.current_role=='editor'}}">
                  <oj-editor-paper-controls flex paper={{paper}}></oj-editor-paper-controls>
              </template>
          </div>

          <div class=right layout vertical>
              <div class='role role-{{paper.current_role}}'><span class=label>Role: </span>{{paper.current_role | capitalize}}</div>
              <div flex class="state state-{{paper.state}}">
                  <div><span class=label>Status: </span>{{paper.state | capitalize}}</div>

                  <template if="{{paper.state=='under_review' && annotations}}">
                      <div>
                          <span class="issue-summary"> <core-icon id='closedIcon' icon='check'></core-icon> {{ countClosed }} <span>Closed<br/>Issues</span></span>
                          <span class="issue-summary"> <core-icon id='openIcon'   icon='error'></core-icon> {{ countOpen }} <span>Open<br/>Issues</span></span>
                      </div>
                  </template>

                  <oj-review-page-actions
                          user={{user}}
                          paper={{paper}}
                      ></oj-review-page-actions>

              </div>
          </div>
      </div>

      <template if='{{loadProgress < 100}}'>
          <paper-progress class=progress value="{{loadProgress}}"></paper-progress>
      </template>


    <style>
        :host {
            display: block;
        }
        .top-header {
            box-sizing: border-box;;
            border-top: solid 2px #4f5783;
            border-bottom: solid 2px #4f5783;
            background: #5C6BC0;
        }

        .left-top {
            padding:   4px;
        }
        .title {
            color:     white;
            font-size: 1.3em;
        }

        .label {
            font-weight: bold;
        }

        .role, .state {
            padding-left:  2px;
            padding-right: 6px;
            flex: 1 0 auto !important;
        }

        .progress {
            position: absolute;
            width:    100%;
        }

        paper-dropdown-menu {
            background: #d0d0d0;
            padding: 0;
            margin:  0;
            padding-left: 4px;
            width: 125px;
        }
        paper-dropdown-menu::shadow core-icon {
            margin: -4px;
        }
        paper-dropdown {
        }
        core-menu {
            margin: 0;
        }
        paper-item {
        }
        paper-item::shadow .button-content {
            padding: 0 0 0 4px;
        }

        span.issue-summary {
            font-size:    0.8em;
            text-align:   right;
            margin-right: 12px;
        }

        span.issue-summary span {
            display:        inline-block;
            vertical-align: middle;
            font-size:      0.6em;
        }

        oj-review-page-actions {
            margin-bottom: 6px;
        }

    </style>

  </template>

  <script>
    Polymer({

        paperChanged: function() {
            this.submitted = this.paper && this.paper.state == 'submitted';
        },

        annotationsChanged: function(){
            this.updateCounts();
        },

        updateCounts: function() {
            if (!this.annotations)
                return;
            this.countNew    = this.annotations.filter(function(annotation){return annotation.new}).length;
            this.countClosed = this.annotations.filter(function(annotation){return annotation.state=='resolved'}).length;
            this.countOpen   = this.annotations.length - this.countClosed - this.countNew;
        },

        exceptReviewers: function(list) {
            return list && list.filter( function(a) { return a.role != 'reviewer' });
        },

        userColor: function(assignment) {
            assignment = Oj.paperHelpers.assignmentFromSha(this.paper, assignment.sha);
            return Oj.colors.userColor(assignment);
        },

        versionSelected: function(event, detail) {
            var sha = this.$.versionMenu.selectedModel.version.sha;
            if (sha != this.paper.sha)
                this.fire('go', '/review/'+sha);
        }

    })
  </script>

</polymer-element>
