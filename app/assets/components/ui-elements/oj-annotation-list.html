<polymer-element name='oj-annotation-list' attributes="paper annotations scale pageHeight pageOffset">
  <template>
    <div layout vertical flex id=list>

      <template repeat="{{annotation in annotations}}">
        <oj-annotation paper={{paper}} annotation={{annotation}}
                       style="top:{{annotation | topForAnnotation}}px"
                       on-annotation-opened={{annotationOpened}}
                ></oj-annotation>
      </template>

      <oj-new-annotation id=new_annotation
                         paper={{paper}}
                         text={{newText}}
                         on-annotation-opened={{annotationOpened}}
                         on-new-annotation-box-dismissed={{newAnnotationDismissed}}
                         on-annotation-added={{newAnnotationAdded}}
              ></oj-new-annotation>
      </template>
    </div>

    <style>
      :host{
        position: relative;
        box-sizing: border-box;
      }
    </style>


  </template>
  <script>
    Polymer({
      scale: 2,
      created: function() {
         this.annotations = [];
      },
      newAnnotationAdded:function(event, annotation){
         this.annotations.push(annotation);
      },
      topForAnnotation: function(annotation){
        page_no = annotation.page;
        if (page_no===undefined || page_no===null) {
            return 0;
        } else {
            y       = annotation.yStart;
            return this.pageOffset + this.pageHeight*page_no + y;
        }
      },
      annotationOpened: function(event, element) {
        this.collapseAnnotations(element);
      },
      collapseAnnotations: function(exclude) {
          var annotations = this.$.list.querySelectorAll('oj-annotation');
          [].forEach.call( annotations, function(annotation) {
             if (annotation != exclude)
                annotation.close();
          });

          var new_annotation = this.$.list.querySelector('oj-new-annotation');
          if (new_annotation && new_annotation != exclude)
              new_annotation.close();
      },
      startNewAnnotation: function(location) {
        var top = this.topForAnnotation(location);
        this.$.new_annotation.style.top = top+'px';
        this.$.new_annotation.location = location;
        this.$.new_annotation.visible = true;
      }
    })
  </script>
</polymer-element>
