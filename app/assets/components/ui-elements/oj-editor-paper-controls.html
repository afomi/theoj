<polymer-element name="oj-editor-paper-controls" attributes='paper'>
  <template>

    <div flex layout horizontal>

      <div layout vertical flex>
        <div layout horizontal>
          <div class="label">Reviewers:</div>
          <div>
            <template if={{submitted}}>
                <oj-user-lookup placeholder="Add Reviewer"
                                on-user-selected={{addReviewer}}
                                on-filter-suggestions={{filterReviewerList}}
                        ></oj-user-lookup>
            </template>
            <template repeat="{{reviewer in paper.assigned_users | onlyReviewers}}">
                <oj-user-tag
                        assignment={{reviewer}}
                        showColor={{!submitted}}
                        showCompleted={{under_review}}
                        tagColor={{userColor(reviewer)}}
                        removable={{submitted}}
                        on-remove-user={{removeReviewer}}
                        ></oj-user-tag>
            </template>
            <template if="{{!submitted && !onlyReviewers(paper.assigned_users)}}">
                This paper does not have any reviewers.
            </template>
          </div>
        </div>
      </div>

    </div>

    <style>
      :host{
        box-sizing: border-box;
        padding: 6px 4px 0 4px;
        width : 100%;
        display: block;
        margin:0;
        margin-bottom: -4px;
        background: #6374cf;
      }
      .label {
          color: white;
          padding-right: 8px;
          padding-top:   2px;
      }
      #status {
        margin-right:60px
      }
      oj-user-tag, oj-user-lookup {
        margin-right: 10px;
        margin-bottom: 10px;
      }
      #status paper-button {
          margin-top: 5px;
          line-height: 0;
          padding 1px 0 2px 0;
      }
    </style>

    <json-post   id=addReviewer    on-success={{updateReviewers}} ></json-post>
    <json-delete id=removeReviewer on-success={{updateReviewers}} ></json-delete>

  </template>

  <script>
    Polymer({
      paperChanged: function() {
          this.submitted    = this.paper && this.paper.state == 'submitted';
          this.under_review = this.paper && this.paper.state == 'under_review';
      },
      removeReviewer:function(event, assignment){
        this.$.removeReviewer.url = Oj.urls.removeAssigneePath(this.paper, assignment);
        this.$.removeReviewer.go();
      },
      addReviewer:function(event, user){
        this.$.addReviewer.url = Oj.urls.addAssigneePath(this.paper, user);
        this.$.addReviewer.go();
      },
      updateReviewers:function(event, detail){
        this.paper.assigned_users = detail;
      },

      filterReviewerList: function(event, suggestions) {
          var paper = this.paper;

          event.result = suggestions.filter( function(item) {

              for (var i=0; i < paper.assigned_users.length; i++) {
                  var user = paper.assigned_users[i].user;
                  if (user.sha == item.sha)
                    return false;
              }

              return true;
          });
      },

      onlyReviewers: function(list) {
        return list && list.filter( function(a) { return a.role == 'reviewer' });
      },

      userColor: function(assignment) {
          assignment = Oj.paperHelpers.assignmentFromSha(this.paper, assignment.sha);
          return Oj.colors.userColor(assignment);
      }
    })
  </script>

</polymer-element>
