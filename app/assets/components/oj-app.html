<polymer-element name="oj-app" id="oj-app">
  <template>
    <core-scaffold id='scaffold'>
      <nav>
        <core-toolbar>
          <span class="title">The Open Journal</span>
        </core-toolbar>

        <core-menu id='mainMenu' selected='home' valueattr='id' class="main-menu">

          <core-item id='' icon="home" label="Home" horizontal center layout>
            <a is='push' href="/#" target="_self"></a>
          </core-item>

          <core-item id='about' icon="info-outline" label="About" horizontal center layout>
            <a href="/#/about" target="_self"></a>
          </core-item>

          <template if={{user}}>
            <core-item id='papers' icon="receipt" label="Your Papers" horizontal center layout>
              <a href="/#/papers" target="_self"></a>
            </core-item>

            <core-item id='submit' icon="send" label="Submit" horizontal center layout>
              <a href="/#/submit" target="_self"></a>
            </core-item>
          </template>

        </core-menu>

      </nav>

      <core-toolbar tool flex>
        <div flex></div>
        <oj-user-login user={{user}} userReady={{userReady}}></oj-user-login>
      </core-toolbar>

      <app-router id="router" on-state-change="{{validateOrRedirectUser}}" on-notification={{notify}}>
        <app-route path='/' element='oj-home-page' bindRouter></app-route>
        <app-route path="/review/:paper_id" element='oj-review-page' bindRouter></app-route>
        <app-route path='/about'  element='oj-about-page'  bindRouter></app-route>
        <app-route path='/submit' element='oj-submit-page' on-before-data-binding={{bindExtrAttributes}} bindRouter></app-route>
        <app-route path='/papers' element='oj-papers-page' on-before-data-binding={{bindExtrAttributes}} bindRouter></app-route>
        <app-route path='/papers/:paper_id/preview' element='oj-paper-preview' on-before-data-binding={{bindExtraAttributes}} bindRouter></app-route>
      </app-router>
    </core-scaffold>

    <paper-toast id="notification" class="capsule core-transition core-transition-bottom" text=""role="status" touch-action="none" tabindex="-1"></paper-toast>

    <style>
      :host /deep/ core-toolbar {
        background-color: #5C6BC0;
        color: #fff;
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      }

      :host /deep/ core-menu {
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      }

      .title {
        font-size: 25px;
      }

      :host /deep/ #mainContainer{
        background-color: white;
      }

      :host core-menu /deep/ #drawer{
        background-color: #7986CB;
      }

      #notification {
        border-radius:0;
        padding-right: 60px;
        position: fixed;
        outline: none;
        z-index: 24;
        box-sizing: border-box;
      }


    </style>
  </template>

  <script>
    Polymer({
      validateOrRedirectUser:function(event){
        validLoggedOutRoutes = ["/","/about"];



        if(this.userReady){

          path = event.detail.path;
          this.$.mainMenu.selected = path.split("/")[1]

          if(!this.user && validLoggedOutRoutes.indexOf(path) == -1){
            event.preventDefault();
            this.showNotification("Please log in");
            this.$.router.go('/');
          }

        }
        else{
          setTimeout(function(){
            this.validateOrRedirectUser(event);
          }.bind(this), 200)
        }
      },
      bindExtraAttributes:function(event){
        event.detail.model.user = this.user;
      },
      notify:function(event){
        this.showNotification(event.detail);
      },
      showNotification:function(text){
        console.log('Notification: ', text);
        this.$.notification.text = text;
        this.$.notification.show();
      }
    });
  </script>

</polymer-element>
