<polymer-element name="oj-review-page" attributes='paper_id currentUser'>
  <template>

    <oj-review-page-header
            id=header
            user={{currentUser}}
            paper={{paper}}
            annotations={{annotations}}
            loadProgress={{loadProgress}}
            ></oj-review-page-header>


    <template if="{{paper}}">
      <div id=main layout horizontal>

        <div layout vertical id=pdf-pane>

          <template if={{paper.can_annotate}}>
              <div id=add-document-issue>
                <paper-button raised on-tap="{{addDocumentAnnotation}}">
                  <paper-icon-button icon=add></paper-icon-button>Add a comment about the whole document
                </paper-button>
              </div>
          </template>

          <stacked-pdf-reader src={{paper.document_location}}
                              annotations={{annotations}}
                              pageOffset={{pageOffset}}
                              loadProgress={{loadProgress}}
                              on-page-clicked={{pageClicked}}
                              on-pdf-client-changed={{pdfClientChanged}}
                  ></stacked-pdf-reader>
        </div>

        <oj-annotation-list id=annotation_list
                            flex
                            paper={{paper}}
                            annotations={{annotations}}
                            firstPageOffset="{{ paper.can_annotate ? 84 : 22 }}"
                            pageHeight={{pdfClientHeight}}
                            pageSpacing={{20}}
                            on-annotation-changed={{onChangeAnnotation}}
                ></oj-annotation-list>
        </div>
      </template>

    <style>

      oj-review-page-header {
          margin-bottom: 20px;
      }

      #pdf-pane {
          box-sizing: border-box;
          width: 65%;
          margin-right: 4px;
      }
      #add-document-issue {
          margin-right: 6px;
      }
      #add-document-issue paper-button {
          box-sizing: border-box;
          width: 100%;
      }
      #main {
          margin-top: 5px;
      }

    </style>

    <json-get auto=true url="{{paper_id | paperPath}}" result={{paper}}></json-get>

    <template if={{paper}}>
      <firebase-element
        id=annotation-firebase
        location="{{paper_id | annotationsFirebasePath }}"
        data={{data}}
        keys={{keys}}
        data-change={{updateAnnotations}}
      ></firebase-element>

    </template>

  </template>

  <script>
    Polymer({

      /**** external API *********/

      getSectionName: function() {
          return 'none';
      },

      /*** Polymer callbacks *****/

      created: function() {
        this.annotations = [];
      },

      paperChanged: function() {
          if (this.paper) {
              var current_user_sha          = this.currentUser && this.currentUser.sha;
              this.paper.current_assignment = Oj.utils.detect(this.paper.assigned_users, function(a) {return a.user && a.user.sha == current_user_sha} );
              this.paper.current_role       = (this.paper.current_assignment && this.paper.current_assignment.role) || 'none';
              this.paper.can_annotate       = this.paper.current_assignment && this.paper.state == 'under_review';

              this.fire('route-changed', this.menuSectionForRole(this.paper.current_role) );
          }
      },

     /******************************/

        menuSectionForRole: function(role) {
          switch (role) {
              case     'editor':       return 'editing';
              case     'reviewer':     return 'review';
              case     'submittor':    return 'submitted';
              case     'collaborator': return 'submitted';
              default:                 return '';
          }
      },
      pdfClientChanged: function(event, detail) {
        this.pdfClientHeight = detail.clientHeight;
      },
      onChangeAnnotation:function(event, annotation) {
        this.$.header.updateCounts();
      },
      keysChanged:function(){
        // console.log('mapping ');
        // console.log(this.keys.map(function(key){return this.data[key]}.bind(this)));
        this.annotations = this.keys.map(function(key){return this.data[key]}.bind(this));
      },
      updateAnnotations:function(event){
          // console.log("UPDATING ANNOTAITONS");
          // console.log($.extend({},event));
      },
      newAnnotation: function(properties) {
          return $.extend( {state:'new', new:true, open:true}, properties);
      },
      pageClicked:function(event, position){
          var annotation = this.newAnnotation( position );
          this.addAnnotation(annotation);
      },
      addDocumentAnnotation: function(event) {
          var annotation = this.newAnnotation();
          this.addAnnotation(annotation);
      },
      addAnnotation: function(annotation) {
          if (this.paper.can_annotate) {
              this.annotations.push(annotation);
          }
      }

    })
  </script>

</polymer-element>
