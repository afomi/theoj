<polymer-element name="oj-review-page" attributes='paper_id user router'>
  <template>

    <oj-review-page-header
            id=header
            user={{user}}
            paper={{paper}}
            annotations={{annotations}}
            router={{router}}
            loadProgress={{loadProgress}}
            ></oj-review-page-header>


    <template if="{{paper}}">
      <div id=main layout horizontal>

        <div layout vertical id=pdf-pane>

          <div id=add-document-issue>
            <paper-button raised on-tap="{{addDocumentAnnotation}}">
              <paper-icon-button icon=add></paper-icon-button>Add a comment about the whole document
            </paper-button>
          </div>
          <stacked-pdf-reader src={{paper.location}}
                              annotations={{annotations}}
                              pageOffset={{pageOffset}}
                              loadProgress={{loadProgress}}
                              on-page-clicked={{pageClicked}}
                              on-pdf-client-changed={{pdfClientChanged}}
                  ></stacked-pdf-reader>
        </div>

        <oj-annotation-list id=annotation_list
                            flex
                            paper={{paper}}
                            annotations={{annotations}}
                            firstPageOffset={{84}}
                            pageHeight={{pdfClientHeight}}
                            pageSpacing={{20}}
                            on-annotation-changed={{onChangeAnnotation}}
                ></oj-annotation-list>
        </div>
      </template>

    <style>

      oj-review-page-header {
          margin-bottom: 20px;
      }

      #pdf-pane {
          box-sizing: border-box;
          width: 65%;
          margin-right: 4px;
      }
      #add-document-issue {
          margin-right: 6px;
      }
      #add-document-issue paper-button {
          box-sizing: border-box;
          width: 100%;
      }
      #main {
          margin-top: 5px;
      }

    </style>

    <json-get auto=true url="{{paper_id | paperPath}}" result={{paper}}></json-get>

    <template if={{paper}}>
      <firebase-element
        id=annotation-firebase
        location="{{paper_id | annotationsFirebasePath }}"
        data={{data}}
        keys={{keys}}
        data-change={{updateAnnotations}}
      ></firebase-element>

    </template>

  </template>

  <script>
    Polymer({

      created: function() {
        this.annotations = [];
      },
      pdfClientChanged: function(event, detail) {
        this.pdfClientHeight = detail.clientHeight;
      },
      paperChanged: function() {
        if (this.paper) {
            var current_user_sha = this.user.sha;
            var index = Oj.utils.indexOf(this.paper.assigned_users, function(a) {return a.user && a.user.sha == current_user_sha} );
            this.paper.current_assignment = this.paper.assigned_users[index];
            this.paper.current_role       = this.paper.current_assignment.role;
        }
      },
      onChangeAnnotation:function(event, annotation) {
        this.$.header.updateCounts();
      },
      keysChanged:function(){
        // console.log('mapping ');
        // console.log(this.keys.map(function(key){return this.data[key]}.bind(this)));
        this.annotations = this.keys.map(function(key){return this.data[key]}.bind(this));
      },
      updateAnnotations:function(event){
          // console.log("UPDATING ANNOTAITONS");
          // console.log($.extend({},event));
      },
      newAnnotation: function(properties) {
          return $.extend( {state:'new', new:true, open:true}, properties);
      },
      pageClicked:function(event, position){
        var annotation = this.newAnnotation( position );
        this.annotations.push(annotation);
      },
      addDocumentAnnotation: function(event) {
        var annotation = this.newAnnotation();
        this.annotations.push(annotation);
      }

    })
  </script>

</polymer-element>
