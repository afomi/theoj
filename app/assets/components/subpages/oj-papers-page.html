<polymer-element name='oj-papers-page' attributes='src header' fit>
  <template>
      
    <section id=scroller layout vertical class=boiler-plate>

      <div layout horizontal>
          <h1 flex>{{header}}</h1>
          <paper-dropdown-menu on-core-select={{changeSortOrder}} label="Submitted Date">
              <paper-dropdown class="dropdown">
                  <core-menu class="menu" selected=3>
                      <paper-item key=title>Article Title</paper-item>
                      <paper-item key=author.name>Author</paper-item>
                      <paper-item key=state>State</paper-item>
                      <paper-item key=submitted_at desc>Submitted Date</paper-item>
                  </core-menu>
              </paper-dropdown>
          </paper-dropdown-menu>
      </div>

      <div layout vertical flex>
          <paper-shadow>

              <template if="{{papers && papers.length>0}}">
                  <core-list scrollTarget={{$.scroller}}
                             on-core-activate={{selectPaper}}
                             data="{{papers | filtered(sortKey, sortDesc) }}" >

                      <template>
                          <div class='item {{ {selected: selected} | tokenList }}'>
                              <oj-paper-row paper={{model}}></oj-paper-row>
                          </div>
                      </template>

                  </core-list>
              </template>

              <template if="{{papers && papers.length==0}}">
                  <div id=empty>
                      There are no papers to view.
                  </div>
              </template>

          </paper-shadow>
      </div>

    </section>

    <style>

        paper-dropdown-menu {
            width: 200px;
        }

        paper-shadow{
            width:         100%;
            margin-bottom: 12px;
        }

        #scroller {
            position:   relative;
            overflow-y: auto;
            height:     100%;
        }
        core-list{
            width: 100%;
        }
        #empty {
            font-weight: 500;
            font-size: 18px;
            padding: 20px 10px;
        }
        .item {
            border-bottom: 1px #efefef solid;
            box-sizing: border-box;
            padding:    0 0 0 20px;
        }

    </style>

    <core-ajax auto url={{src}} handleAs="json" response={{papers}}></core-ajax>

  </template>

  <script>
    Polymer({

        sortKey:  'submitted_at',
        sortDesc: true,

        changeSortOrder: function(event, detail) {
            this.sortKey  = detail.item.getAttribute('key');
            this.sortDesc = detail.item.hasAttribute('desc');
        },

        selectPaper: function(e, detail){
            this.fire('review', detail.data);
        },

        filtered: function(array, key, desc) {
            if (!array)
                return array;

            var keys = key.split('.');
            var sortFunction = function(a, b) {
                var x = a;
                keys.forEach( function(key) { x = x && x[key] } );
                var y = b;
                keys.forEach( function(key) { y = y && y[key] } );

                if (typeof x == "string"){
                    x = x.toLowerCase();
                    y = y.toLowerCase();
                }

                var order = ((x < y) ? -1 : ((x > y) ? 1 : 0));
                return desc ? -order : order;
            };

            return array.sort(sortFunction);
        }

    })
  </script>

</polymer-element>
