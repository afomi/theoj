<polymer-element name="oj-page-router" attributes='currentUserReady currentUser'>
    <template>

        <app-router id=router
                    mode=pushstate
                    on-activate-route-start={{activateRouteStart}}
                    on-before-data-binding={{beforeDataBinding}}
                    on-activate-route-end={{activateRouteEnd}}
                    >

            <app-route path='/' element='oj-home-page' noAuth></app-route>
            <app-route path='/about' element='oj-about-page' noAuth></app-route>

            <app-route path='/submit' element='oj-submit-page'></app-route>
            <app-route path='/papers'>
                <template>
                    <oj-papers-page src='/api/papers' header="Your submissions"></oj-papers-page>
                </template>
            </app-route>
            <app-route path='/review'>
                <template>
                    <oj-papers-page src='/api/papers/as_reviewer' header="Papers you are reviewing"></oj-papers-page>
                </template>
            </app-route>
            <app-route path='/editing'>
                <template>
                    <oj-papers-page src='/api/papers/as_editor' header="Papers you are editing"></oj-papers-page>
                </template>
            </app-route>
            <app-route path='/settings' element=oj-settings-page></app-route>

            <app-route path="/review/:paper_id" element='oj-review-page'></app-route>
            <app-route path='/papers/:paper_id/preview' element='oj-paper-preview'></app-route>

            <app-route path='*' element='oj-404-page'></app-route>
        </app-router>

    </template>

    <script>
        Polymer({

            // Public API

            go: function (url) {
                this.$.router.go(url);
            },

            /////////////////////////////////////////////////////

            validateOrRedirectUser: function (event, path, route) {

                // Login not required
                if (!this.loginRequired(route)) {
                    return true;
                }

                // Waiting for current user
                if (!this.currentUserReady) {
                    event.preventDefault();
                    this.async(function () {
                        this.$.router.go(path, {replace: true});
                    }.bind(this));
                    return false;
                }

                // User not logged in
                if (!this.currentUser) {
                    event.preventDefault();
                    this.fire('notification', "Please log in");
                    this.$.router.go('/');
                    return false;
                }

                // Force users to enter an email
                if (!this.currentUser.email && path!='/settings') {
                    event.preventDefault();
                    this.fire('notification', "Please enter your email to continue");
                    this.$.router.go('/settings');
                    return false;
                }

                // login successful
                return true;
            },

            loginRequired: function (route) {
                return !route.hasAttribute('noAuth');
            },

            bindExtraAttributes: function (model) {
                model.user        = this.currentUser;
                model.currentUser = this.currentUser;
            },

            pageInstanceForRoute: function(route) {
                return route.children[route.children.length-1];
            },

            activateRouteStart: function (event, detail) {
                var path = event.detail.path;
                var route = event.detail.route;
                return this.validateOrRedirectUser(event, path, route);
            },

            beforeDataBinding: function(event, detail) {
                return this.bindExtraAttributes(detail.model);
            },

            activateRouteEnd: function (event, detail) {
                var path      = detail.path;
                var route     = detail.route;
                var instance  = this.pageInstanceForRoute(route);
                route.activeInstance = instance;

                this.fire('route-changed', {
                    path:     path,
                    route:    route,
                    instance: instance
                });

            }

        });
  </script>

</polymer-element>
